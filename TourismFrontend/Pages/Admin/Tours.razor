@page "/admin/tours"
@using TourismFrontend.Models
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@inject TourService TourService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@attribute [Authorize(Roles = "Admin,Manager")]

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞–º–∏</h2>
        <button class="btn btn-primary" @onclick="() => ShowTourModal(null)">
            <i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä
        </button>
    </div>

    @if (tours == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–°—Ç—Ä–∞–Ω–∞</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–î–∞—Ç—ã</th>
                        <th>–ú–µ—Å—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tour in tours)
                    {
                        <tr>
                            <td>@tour.Name</td>
                            <td>@tour.Country</td>
                            <td>@tour.Price.ToString("C0")</td>
                            <td>@tour.DepartureDate.ToString("dd.MM.yyyy") - @tour.ReturnDate.ToString("dd.MM.yyyy")</td>
                            <td>@tour.AvailableSeats</td>
                            <td>
                                @if (tour.IsHot)
                                {
                                    <span class="badge bg-danger">–ì–æ—Ä—è—â–∏–π</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => ShowTourModal(tour)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTour(tour.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <EditForm Model="@currentTour">
                    <DataAnnotationsValidator />
                    <div class="modal-header">
                        <h5 class="modal-title">@(currentTour.Id == 0 ? "–î–æ–±–∞–≤–∏—Ç—å —Ç—É—Ä" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä")</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <InputText @bind-Value="currentTour.Name" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.Name)" />
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                                <InputText @bind-Value="currentTour.Country" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.Country)" />
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <InputTextArea @bind-Value="currentTour.Description" class="form-control" rows="3" />
                                <ValidationMessage For="@(() => currentTour.Description)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–¶–µ–Ω–∞</label>
                                <InputNumber @bind-Value="currentTour.Price" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.Price)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
                                <InputNumber @bind-Value="currentTour.AvailableSeats" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.AvailableSeats)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                                <InputDate @bind-Value="currentTour.DepartureDate" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.DepartureDate)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è</label>
                                <InputDate @bind-Value="currentTour.ReturnDate" class="form-control" />
                                <ValidationMessage For="@(() => currentTour.ReturnDate)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–†–µ–π—Ç–∏–Ω–≥</label>
                                <InputNumber @bind-Value="currentTour.Rating" class="form-control" step="0.1" />
                                <ValidationMessage For="@(() => currentTour.Rating)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                <div class="d-flex gap-3 align-items-start">
                                    <div class="flex-grow-1">
                                        <InputText class="form-control mb-2" 
                                                  @bind-Value="currentTour.ImageUrl" 
                                                  placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" />
                                        <div class="form-text">
                                            –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                        </div>
                                    </div>
                                    <div>
                                        <InputFile OnChange="HandleImageUpload" 
                                                  class="form-control" 
                                                  accept="image/*" />
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(currentTour.ImageUrl))
                                {
                                    <div class="mt-2">
                                        <img src="@currentTour.ImageUrl" 
                                             class="img-thumbnail" 
                                             style="max-height: 200px" 
                                             alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" />
                                    </div>
                                }
                            </div>

                            <div class="col-md-12">
                                <div class="form-check">
                                    <InputCheckbox @bind-Value="currentTour.IsHot" class="form-check-input" id="isHot" />
                                    <label class="form-check-label" for="isHot">–ì–æ—Ä—è—â–∏–π —Ç—É—Ä</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <hr class="my-4">
                                <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ</h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è</label>
                                <InputText @bind-Value="currentTour.HotelName" class="form-control" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥</label>
                                <InputSelect @bind-Value="currentTour.HotelStars" class="form-control">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <option value="@i">@(new string('‚≠ê', i))</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-12">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–µ–ª—è</label>
                                <InputTextArea @bind-Value="currentTour.HotelDescription" class="form-control" rows="3"
                                              placeholder="–û–ø–∏—à–∏—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–µ–ª—è, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É..." />
                            </div>

                            <div class="col-12">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤</label>
                                <InputTextArea @bind-Value="currentTour.RoomDescription" class="form-control" rows="3"
                                              placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–∏–ø—ã –Ω–æ–º–µ—Ä–æ–≤, –∏—Ö –æ—Å–Ω–∞—â–µ–Ω–∏–µ..." />
                            </div>

                            <div class="col-12">
                                <label class="form-label">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                                <InputTextArea @bind-Value="currentTour.Location" class="form-control" rows="2"
                                              placeholder="–û–ø–∏—à–∏—Ç–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–µ–ª—è, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –º–æ—Ä—è, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π..." />
                            </div>

                            <div class="col-12">
                                <hr class="my-4">
                                <h5>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                <InputTextArea @bind-Value="inclusionsText" class="form-control" rows="6" 
                                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:
‚úàÔ∏è –ü–µ—Ä–µ–ª–µ—Ç
üè® –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ
üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ all inclusive
üöå –¢—Ä–∞–Ω—Å—Ñ–µ—Ä
üìã –°—Ç—Ä–∞—Ö–æ–≤–∫–∞" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">–ß—Ç–æ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                <InputTextArea @bind-Value="exclusionsText" class="form-control" rows="6"
                                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:
üé´ –í–∏–∑–∞
üèõÔ∏è –≠–∫—Å–∫—É—Ä—Å–∏–∏
üç∑ –ù–∞–ø–∏—Ç–∫–∏
üí∞ –ß–∞–µ–≤—ã–µ
üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è" />
                            </div>

                            <div class="col-12">
                                <label class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–µ</label>
                                <InputTextArea @bind-Value="currentTour.TransferInfo" class="form-control" rows="2"
                                              placeholder="–£–∫–∞–∂–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞, —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏..." />
                            </div>

                            <div class="col-12">
                                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                                <InputTextArea @bind-Value="currentTour.AdditionalInfo" class="form-control" rows="3"
                                              placeholder="–õ—é–±–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏..." />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-primary" disabled="@isSaving" @onclick="async () => { if (!isSaving) await HandleValidSubmit(); }">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                            }
                            else
                            {
                                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<Tour>? tours;
    private Tour currentTour = new();
    private bool showModal;
    private string inclusionsText = "";
    private string exclusionsText = "";
    private IBrowserFile? selectedFile;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–∞–º–∏...");
        await LoadTours();
    }

    private async Task LoadTours()
    {
        Console.WriteLine("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—É—Ä–æ–≤...");
        tours = await TourService.GetToursAsync();
        Console.WriteLine($"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {tours?.Count ?? 0} —Ç—É—Ä–æ–≤");
    }

    private void ShowTourModal(Tour? tour)
    {
        Console.WriteLine($"–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {(tour == null ? "—Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–∞" : $"—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞ {tour.Id}")}");
        if (tour == null)
        {
            currentTour = new Tour();
            inclusionsText = "";
            exclusionsText = "";
        }
        else
        {
            currentTour = new Tour
            {
                Id = tour.Id,
                Name = tour.Name,
                Description = tour.Description,
                Country = tour.Country,
                Price = tour.Price,
                DepartureDate = tour.DepartureDate,
                ReturnDate = tour.ReturnDate,
                Duration = tour.Duration,
                AvailableSeats = tour.AvailableSeats,
                Rating = tour.Rating,
                IsHot = tour.IsHot,
                ImageUrl = tour.ImageUrl,
                Inclusions = tour.Inclusions,
                Exclusions = tour.Exclusions,
                HotelName = tour.HotelName,
                HotelStars = tour.HotelStars,
                HotelDescription = tour.HotelDescription,
                RoomDescription = tour.RoomDescription,
                Location = tour.Location,
                TransferInfo = tour.TransferInfo,
                AdditionalInfo = tour.AdditionalInfo
            };
            inclusionsText = string.Join("\n", tour.Inclusions);
            exclusionsText = string.Join("\n", tour.Exclusions);
        }
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentTour = new Tour();
    }

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        await Task.Run(() => selectedFile = e.File);
    }

    private async Task HandleValidSubmit()
    {
        if (isSaving) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
        
        isSaving = true;
        try
        {
            Console.WriteLine("–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã...");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (string.IsNullOrWhiteSpace(currentTour.Name))
            {
                ToastService.ShowError("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
                isSaving = false;
                return;
            }
            
            if (string.IsNullOrWhiteSpace(currentTour.Country))
            {
                ToastService.ShowError("–°—Ç—Ä–∞–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞");
                isSaving = false;
                return;
            }
            
            if (string.IsNullOrWhiteSpace(currentTour.Description))
            {
                ToastService.ShowError("–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
                isSaving = false;
                return;
            }
            
            if (currentTour.Price <= 0)
            {
                ToastService.ShowError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0");
                isSaving = false;
                return;
            }
            
            if (currentTour.AvailableSeats <= 0)
            {
                ToastService.ShowError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0");
                isSaving = false;
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (currentTour.ReturnDate < currentTour.DepartureDate)
            {
                ToastService.ShowError("–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è");
                isSaving = false;
                return;
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç
            currentTour.Duration = (int)(currentTour.ReturnDate - currentTour.DepartureDate).TotalDays + 1;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 365 –¥–Ω–µ–π
            if (currentTour.Duration > 365)
            {
                ToastService.ShowError("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π");
                isSaving = false;
                return;
            }
            
            // –ï—Å–ª–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (string.IsNullOrWhiteSpace(currentTour.ImageUrl))
            {
                currentTour.ImageUrl = "/images/default-tour.jpg";
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥
            currentTour.Inclusions = inclusionsText
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .ToList();

            currentTour.Exclusions = exclusionsText
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .ToList();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                ToastService.ShowError("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
                NavigationManager.NavigateTo("/login");
                isSaving = false;
                return;
            }

            if (currentTour.Id == 0)
            {
                Console.WriteLine("–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–∞...");
                Console.WriteLine($"–î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞: {JsonSerializer.Serialize(currentTour)}");
                await TourService.CreateTourAsync(currentTour);
                ToastService.ShowSuccess("–¢—É—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
            }
            else
            {
                Console.WriteLine($"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞ —Å ID {currentTour.Id}...");
                Console.WriteLine($"–î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞: {JsonSerializer.Serialize(currentTour)}");
                await TourService.UpdateTourAsync(currentTour);
                ToastService.ShowSuccess("–¢—É—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω");
            }

            await LoadTours();
            showModal = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—É—Ä–∞: {ex.Message}");
            Console.WriteLine($"–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤: {ex.StackTrace}");
            ToastService.ShowError($"–û—à–∏–±–∫–∞: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                ToastService.ShowError("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");
                return;
            }

            var file = e.File;
            var imageUrl = await TourService.UploadImageAsync(file.OpenReadStream(), file.Name);
            currentTour.ImageUrl = imageUrl;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {ex.Message}");
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            if (ex.Message.Contains("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"))
            {
                NavigationManager.NavigateTo("/login");
            }
        }
    }

    private async Task DeleteTour(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—É—Ä?"))
        {
            try
            {
                await TourService.DeleteTourAsync(id);
                await LoadTours();
                ToastService.ShowSuccess("–¢—É—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—É—Ä–∞: {ex.Message}");
            }
        }
    }
} 